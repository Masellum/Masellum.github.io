<!DOCTYPE html><html lang="zh-CN"><head><link rel=manifest href=/manifest.json><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Masellum 的互联网日志"><title>SYZOJ 部署指南 | Mas's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="stylesheet" href="//cdn.staticfile.org/KaTeX/0.7.1/katex.min.css"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">SYZOJ 部署指南</h1><a id="logo" href="/.">Mas's Blog</a><p class="description">观察，思考，记录。</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">SYZOJ 部署指南</h1><div class="post-meta">Aug 21, 2018<span> | </span><span class="category"><a href="/categories/其他/">其他</a></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 4,219</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 19</span><span class="post-meta-item-text"> 分钟</span></span></span></div><a class="disqus-comment-count" data-disqus-identifier="2018/08/syzoj-setup/" href="/2018/08/syzoj-setup/#disqus_thread"></a><div class="post-content"><p><a href="https://github.com/syzoj/" target="_blank" rel="noopener">SYZOJ</a> 是主要由 <a href="https://github.com/Menci" target="_blank" rel="noopener">Menci</a> 与 <a href="https://github.com/t123yh" target="_blank" rel="noopener">t123yh</a> 开发的在线评测系统，具有界面美观、后台管理可视化等优点，为许多学校用于搭建校内OJ，并被 <a href="https://loj.ac/" target="_blank" rel="noopener">Libre OJ</a> 使用。但由于开发者时间紧张，长期没有完善安装文档，其 GitHub 主页上的安装指南已严重过期，网上能搜索到的安装指南也要么过于老旧要么过于简略。在经历过三天痛苦的摸索后，我终于成功地部署了 SYZOJ。为了记录自己的部署历程也为了不让后来人重复这一过程，我决定依我浅见写一篇 SYZOJ 部署指南。</p>
<p>本文部署环境为 Ubuntu 16.04，使用的 Node.js 版本为v8.9.3，npm 版本为5.5.1，使用其他版本有可能出现不可解决的 Bug。如果想要在部署 SYZOJ 的同时不影响本机的 Node.js 版本，可以使用 <a href="https://github.com/creationix/nvm" target="_blank" rel="noopener">nvm</a> 管理多个 Node.js 版本。关于 SYZOJ2 在 CentOS 上的搭建，请参考 Victor Huang 的 <a href="https://imvictor.tech/posts/deploying-syzoj2-on-centos/" target="_blank" rel="noopener">SYZOJ2 在 CentOS 上的搭建</a>。</p>
<p>因为我对于许多 Linux 相关知识并不了解，本文中有很多地方是带着”能用就行“的似是而非的感觉写的，请辩证参考。本文中没有提及 SYZOJ2 的邮件验证系统的相关内容。</p>
<p>在部署过程中，可以通过</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh demo-guest@t123yh.xyz -p 22223</span><br></pre></td></tr></table></figure>
<p>ssh 到 Demo 服务器上查看实际环境下的表现。</p>
<p>本文参考 t123yh 写的 <a href="https://blog.t123yh.xyz:2/index.php/archives/236" target="_blank" rel="noopener">SYZOJ 搭建指南</a> 和不是 t123yh 写的 <a href="https://blog.csdn.net/buyaoxx/article/details/77504043" target="_blank" rel="noopener">SYZOJ 中文安装指南</a>。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>SYZOJ 由 web 端 和 judge 端构成，其中 judge 端又由 daemon、frontend、runner 三个部分组成，每个部分都能同时启动多个实例。想要部署 SYZOJ 需要至少四个进程的相互配合。</p>
<h3 id="daemon"><a href="#daemon" class="headerlink" title="daemon"></a>daemon</h3><p>daemon 主要负责获取评测任务，并将评测任务分散为若干个较为轻量的子任务（编译和评测），这些任务再由 runner 来执行。</p>
<h3 id="runner"><a href="#runner" class="headerlink" title="runner"></a>runner</h3><p>runner 是实际执行评测任务的部分。</p>
<h3 id="frontend"><a href="#frontend" class="headerlink" title="frontend"></a>frontend</h3><p>frontend 是 daemon 与 Web 端沟通的桥梁，它使用 HTTP 协议接收 Web 端传送来的评测任务，并将其推入消息队列供 daemon 部分执行。同时，它还负责向客户端推送评测进度。</p>
<h2 id="部署步骤"><a href="#部署步骤" class="headerlink" title="部署步骤"></a>部署步骤</h2><h3 id="获取代码"><a href="#获取代码" class="headerlink" title="获取代码"></a>获取代码</h3><p>从 GitHub 上分别获取 web 端和 judge 端的源代码。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/syzoj/syzoj.git /var/syzoj-web</span><br><span class="line">git clone https://github.com/syzoj/syzoj-judge-v3.git /var/syzoj-judge-v3</span><br></pre></td></tr></table></figure>
<p>本文的部署过程中将 web 端放在 <code>/var/syzoj-web</code> 目录，judge 端放在 <code>/var/syzoj-judge-v3</code> 目录。</p>
<p>从 <a href="https://seafile.t123yh.xyz:2/f/65f061a56f414b3db478/" target="_blank" rel="noopener">这个链接</a> 下载 sandbox-rootfs，使用 root 权限解压到根目录下。</p>
<h3 id="安装依赖项"><a href="#安装依赖项" class="headerlink" title="安装依赖项"></a>安装依赖项</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apt install build-essential libboost1.58-all-dev nodejs rabbitmq-server redis-server nginx p7zip-full</span><br><span class="line">cd /var/syzoj-web</span><br><span class="line">npm i</span><br><span class="line">cd /var/syzoj-judge-v3</span><br><span class="line">npm i</span><br></pre></td></tr></table></figure>
<p>SYZOJ 使用的 simple-sandbox 需要使用 boost 库。</p>
<p>SYZOJ 使用 RabbitMQ 消息队列实现各个进程之间的通信，使用 Redis 实现多个 runner 共享一份可执行程序。</p>
<p>你需要分别在 web 端目录和 judge 端目录使用 npm 安装项目的依赖。npm 使用国内镜像源加速的方法不再赘述，读者可自行了解。注意使用 root 用户执行 <code>npm i</code> 时应加上 <code>--unsafe-perm</code> 参数。</p>
<h3 id="安装与配置数据库"><a href="#安装与配置数据库" class="headerlink" title="安装与配置数据库"></a>安装与配置数据库</h3><p>SYZOJ 默认使用 sqlite3 作为数据库。这里我们改用更强大也更普遍的 MySQL。MySQL 的安装不再赘述。</p>
<p>打开 MySQL cli，输入以下代码，注意自行将中括号中内容替换为你的自定义内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE syzoj;</span><br><span class="line">ALTER DATABASE syzoj CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;</span><br><span class="line">CREATE USER &apos;syzoj&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;[your_password]&apos;;</span><br><span class="line">GRANT ALL ON syzoj.* TO &apos;syzoj&apos;@&apos;localhost&apos;;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>
<p>这些代码创建了名为<code>syzoj</code>的数据库，创建了名为 <code>syzoj</code> 的数据库用户并更改了数据库权限。</p>
<h3 id="启用内存控制相关的内核选项"><a href="#启用内存控制相关的内核选项" class="headerlink" title="启用内存控制相关的内核选项"></a>启用内存控制相关的内核选项</h3><p>simple-sandbox 使用了 cgroup 来进行内存用量控制，该过程需要用到 memory.memsw（控制内存和交换空间的总用量）。一些 Linux 发行版的内核在默认情况下，没有启用这个内核选项，你需要手动启用它。</p>
<p>检查文件 <code>/sys/fs/cgroup/memory/memory.memsw.usage_in_bytes</code> 是否存在。如果不存在，你需要使用你的 grub 启用。
打开 <code>/etc/default/grub</code>，找到其中的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRUB_CMDLINE_LINUX_DEFAULT="quiet splash"</span><br></pre></td></tr></table></figure>
<p>这一行（引号内内容可能有不同），在其后添加 <code>cgroup_enable=memory swapaccount=1</code>。以上述为例，添加后该行应为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRUB_CMDLINE_LINUX_DEFAULT="quiet splash cgroup_enable=memory swapaccount=1"</span><br></pre></td></tr></table></figure>
<p>修改后执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update-grub &amp;&amp; reboot</span><br></pre></td></tr></table></figure>
<p>来更新 grub 配置并重启。重启后，重新检查文件 <code>/sys/fs/cgroup/memory/memory.memsw.usage_in_bytes</code> 是否存在。</p>
<h3 id="构建源代码"><a href="#构建源代码" class="headerlink" title="构建源代码"></a>构建源代码</h3><p>SYZOJ 部分使用了 TypeScript。你需要手动将 TypeScript 编译成 JavaScript。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /var/syzoj-judge-v3</span><br><span class="line">npm run build</span><br></pre></td></tr></table></figure>
<h3 id="复制并修改配置文件"><a href="#复制并修改配置文件" class="headerlink" title="复制并修改配置文件"></a>复制并修改配置文件</h3><p>SYZOJ 可以指定运行所用配置文件的位置。为了便于统一管理，建议将配置文件统一放在 <code>/etc/syzoj-config</code> 目录下。</p>
<p>SYZOJ 提供了配置文件示例，我们首先将示例复制过去。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mkdir /mnt/syzoj-data</span><br><span class="line">mkdir /mnt/syzoj-bin</span><br><span class="line">mkdir /mnt/syzoj-tmp1</span><br><span class="line">cd /var/syzoj-judge-v3</span><br><span class="line">mkdir /etc/syzoj-config</span><br><span class="line">cp daemon-config-example.json /etc/syzoj-config/daemon.json</span><br><span class="line">cp runner-shared-config-example.json /etc/syzoj-config/runner-shared.json</span><br><span class="line">cp runner-instance-config-example.json /etc/syzoj-config/runner-instance1.json</span><br><span class="line">cp frontend-config-example.json /etc/syzoj-config/frontend.json</span><br><span class="line">cp /var/syzoj-web/config-example.json /etc/syzoj-config/web.json</span><br></pre></td></tr></table></figure>
<p>SYZOJ 的 <code>runner</code> 可以有多个配置不同的实例，这里我们只复制一份配置文件建立一个实例。接下来你需要按照自己的需求修改配置文件。这里给出一份示例。</p>
<p><code>config.json</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "title": "SYZOJ", // OJ名称</span><br><span class="line">  "hostname": "127.0.0.1", // web 端 IP</span><br><span class="line">  "port": "5283", // web 端端口</span><br><span class="line">  "db": &#123;</span><br><span class="line">    // 如果使用 sqlite3 则不用修改默认配置</span><br><span class="line">    // 因为我们换用了 MySQL 所以需要进行一定修改</span><br><span class="line">    "database": "syzoj", // MySQL 数据库名</span><br><span class="line">    "username": "syzoj", // MySQL 数据库用户名</span><br><span class="line">    "password": "[your_password]", // MySQL 数据库用户密码</span><br><span class="line">    "host": "localhost", // MySQL 数据库地址</span><br><span class="line">    "dialect": "mysql", // 此处更改为 MySQL</span><br><span class="line">    "storage": null</span><br><span class="line">  &#125;,</span><br><span class="line">  "register_mail": false, // 邮箱验证，自行配置，这里为了部署方便设为 false 以关闭</span><br><span class="line">  "email": &#123;</span><br><span class="line">    "method": "aliyundm",</span><br><span class="line">    "options": &#123;</span><br><span class="line">      "AccessKeyId": "xxxx",</span><br><span class="line">      "AccessKeySecret": "xxxx",</span><br><span class="line">      "AccountName": "xxxx"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  "upload_dir": "uploads", // 上传文件路径</span><br><span class="line">  "default": &#123; // 默认配置</span><br><span class="line">    "problem": &#123; // 题目时间限制与空间限制</span><br><span class="line">      "time_limit": 1000,</span><br><span class="line">      "memory_limit": 256</span><br><span class="line">    &#125;,</span><br><span class="line">    "user": &#123; // 用户默认展示，初始 rating 为1500</span><br><span class="line">      "show": true,</span><br><span class="line">      "rating": 1500</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  "sorting": &#123; // 排序方法</span><br><span class="line">    "ranklist": &#123; // 排名默认为按 rating 降序排序</span><br><span class="line">      "field": "rating", // 更改为 "ac_num" 以按 AC 数排序</span><br><span class="line">      "order": "desc"</span><br><span class="line">    &#125;,</span><br><span class="line">    "problem": &#123; // 题目默认以题目编号排序</span><br><span class="line">      "field": "id",</span><br><span class="line">      "order": "asc"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  "limit": &#123; // 最大限制</span><br><span class="line">    "time_limit": 10000,</span><br><span class="line">    "memory_limit": 1024,</span><br><span class="line">    "data_size": 209715200,</span><br><span class="line">    "testdata": 209715200,</span><br><span class="line">    "submit_code": 102400,</span><br><span class="line">    "submit_answer": 10485760,</span><br><span class="line">    "custom_test_input": 20971520,</span><br><span class="line">    "testdata_filecount": 5</span><br><span class="line">  &#125;,</span><br><span class="line">  "page": &#123; // 各个页面的显示数量限制</span><br><span class="line">    "problem": 50,</span><br><span class="line">    "problem_statistics": 10,</span><br><span class="line">    "judge_state": 10,</span><br><span class="line">    "ranklist": 20,</span><br><span class="line">    "discussion": 10,</span><br><span class="line">    "article_comment": 10,</span><br><span class="line">    "contest": 10,</span><br><span class="line">    "edit_contest_problem_list": 10,</span><br><span class="line">    "edit_problem_tag_list": 10</span><br><span class="line">  &#125;,</span><br><span class="line">  "languages": &#123; // 语言配置</span><br><span class="line">    "cpp": &#123;</span><br><span class="line">      "show": "C++",</span><br><span class="line">      "highlight": "cpp",</span><br><span class="line">      "version": "GCC 5.4.0",</span><br><span class="line">      "editor": "c_cpp"</span><br><span class="line">    &#125;,</span><br><span class="line">    "cpp11": &#123;</span><br><span class="line">      "show": "C++11",</span><br><span class="line">      "highlight": "cpp",</span><br><span class="line">      "version": "GCC 5.4.0",</span><br><span class="line">      "editor": "c_cpp"</span><br><span class="line">    &#125;,</span><br><span class="line">    "csharp": &#123;</span><br><span class="line">      "show": "C#",</span><br><span class="line">      "highlight": "csharp",</span><br><span class="line">      "version": "MCS 4.8.0.0, Mono 4.8.0",</span><br><span class="line">      "editor": "csharp"</span><br><span class="line">    &#125;,</span><br><span class="line">    "c": &#123;</span><br><span class="line">      "show": "C",</span><br><span class="line">      "highlight": "c",</span><br><span class="line">      "version": "GCC 5.4.0",</span><br><span class="line">      "editor": "c_cpp"</span><br><span class="line">    &#125;,</span><br><span class="line">    "vala": &#123;</span><br><span class="line">      "show": "Vala",</span><br><span class="line">      "highlight": "vala",</span><br><span class="line">      "version": "Vala 0.30.1, GCC 5.4.0",</span><br><span class="line">      "editor": "vala"</span><br><span class="line">    &#125;,</span><br><span class="line">    "java": &#123;</span><br><span class="line">      "show": "Java",</span><br><span class="line">      "highlight": "java",</span><br><span class="line">      "version": "GCC 5.4.0",</span><br><span class="line">      "editor": "java"</span><br><span class="line">    &#125;,</span><br><span class="line">    "pascal": &#123;</span><br><span class="line">      "show": "Pascal",</span><br><span class="line">      "highlight": "pascal",</span><br><span class="line">      "version": "FPC 3.0.0",</span><br><span class="line">      "editor": "pascal"</span><br><span class="line">    &#125;,</span><br><span class="line">    "lua": &#123;</span><br><span class="line">      "show": "Lua",</span><br><span class="line">      "highlight": "lua",</span><br><span class="line">      "version": "Lua 5.2.4",</span><br><span class="line">      "editor": "lua"</span><br><span class="line">    &#125;,</span><br><span class="line">    "luajit": &#123;</span><br><span class="line">      "show": "LuaJIT",</span><br><span class="line">      "highlight": "lua",</span><br><span class="line">      "version": "LuaJIT 2.0.4",</span><br><span class="line">      "editor": "lua"</span><br><span class="line">    &#125;,</span><br><span class="line">    "python2": &#123;</span><br><span class="line">      "show": "Python 2",</span><br><span class="line">      "highlight": "python",</span><br><span class="line">      "version": "CPython 2.7.12",</span><br><span class="line">      "editor": "python"</span><br><span class="line">    &#125;,</span><br><span class="line">    "python3": &#123;</span><br><span class="line">      "show": "Python 3",</span><br><span class="line">      "highlight": "python",</span><br><span class="line">      "version": "CPython 3.5.2",</span><br><span class="line">      "editor": "python"</span><br><span class="line">    &#125;,</span><br><span class="line">    "nodejs": &#123;</span><br><span class="line">      "show": "Node.js",</span><br><span class="line">      "highlight": "js",</span><br><span class="line">      "version": "7.7.3",</span><br><span class="line">      "editor": "javascript"</span><br><span class="line">    &#125;,</span><br><span class="line">    "ruby": &#123;</span><br><span class="line">      "show": "Ruby",</span><br><span class="line">      "highlight": "ruby",</span><br><span class="line">      "version": "2.3.1",</span><br><span class="line">      "editor": "ruby"</span><br><span class="line">    &#125;,</span><br><span class="line">    "haskell": &#123;</span><br><span class="line">      "show": "Haskell",</span><br><span class="line">      "highlight": "haskell",</span><br><span class="line">      "version": "GHC 7.10.3",</span><br><span class="line">      "editor": "haskell"</span><br><span class="line">    &#125;,</span><br><span class="line">    "ocaml": &#123;</span><br><span class="line">      "show": "OCaml",</span><br><span class="line">      "highlight": "ocaml",</span><br><span class="line">      "version": "Ocamlbuild 4.02.3",</span><br><span class="line">      "editor": "ocaml"</span><br><span class="line">    &#125;,</span><br><span class="line">    "vbnet": &#123;</span><br><span class="line">      "show": "Visual Basic",</span><br><span class="line">      "highlight": "vbnet",</span><br><span class="line">      "version": "VBNC 0.0.0.5943, Mono 4.8.0",</span><br><span class="line">      "editor": "vbscript"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  "links": [ // 友链</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"title"</span>: <span class="string">"LibreOJ"</span>,</span><br><span class="line">      <span class="attr">"url"</span>: <span class="string">"https://loj.ac/"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  "session_secret": "233", // 加密 Token，自行更改，建议复杂一些</span><br><span class="line">  "judge_server_addr": "http://127.0.0.1:5284", // judge 端的地址^</span><br><span class="line">  "judge_token": "233", // 若要修改此项请将 judge 端的 web_token 一同修改</span><br><span class="line">  "email_jwt_secret": "test" // 应该是邮件相关设置</span><br></pre></td></tr></table></figure>
<p><em>^如果想要实现用户浏览器端实时获取评测状态的功能，请将 <code>&quot;judge_server_addr&quot;</code> 字段改为 OJ 的对外地址。参考文首提到的<a href="https://imvictor.tech/posts/deploying-syzoj2-on-centos/" target="_blank" rel="noopener">SYZOJ2 在 CentOS 上的搭建</a>。</em></p>
<p><code>daemon.json</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "RabbitMQUrl": "amqp://localhost/", // RabbitMQ 服务器的路径</span><br><span class="line">  "RedisUrl": "redis://127.0.0.1:6379", // Redis 服务器的路径</span><br><span class="line">  "TestData": "/mnt/syzoj-data/uploads/testdata", // 测试数据存放目录</span><br><span class="line">  "Priority": 1,</span><br><span class="line">  "DataDisplayLimit": 100, // 数据显示限制</span><br><span class="line">  "TempDirectory": "/tmp"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>frontend.json</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "RabbitMQUrl": "amqp://localhost/", // RabbitMQ 服务器地址</span><br><span class="line">  "Listen": &#123;</span><br><span class="line">    "host": "127.0.0.1", "port": 5284</span><br><span class="line">  &#125;, // judge 端的地址与端口</span><br><span class="line">  "RemoteUrl": "http://127.0.0.1:5283", // web 端的地址</span><br><span class="line">  "Token": "233" // 与 web.json 中的 web_token 相同</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>runner-shared.json</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"RabbitMQUrl"</span>: <span class="string">"amqp://localhost/"</span>,</span><br><span class="line">  <span class="attr">"RedisUrl"</span>: <span class="string">"redis://127.0.0.1:6379"</span>,</span><br><span class="line">  "TestData": "/mnt/syzoj-data/uploads/testdata", // 与 daemon.json 中的 TestData 相同</span><br><span class="line">  "Priority": 1,</span><br><span class="line">  "DebugMessageDisplayLimit": 5000,</span><br><span class="line">  "OutputLimit": 104857600,</span><br><span class="line">  "StderrDisplayLimit": 5120,</span><br><span class="line">  "DataDisplayLimit": 128,</span><br><span class="line">  "CompilerMessageLimit": 50000,</span><br><span class="line">  "SpjTimeLimit": 1501,</span><br><span class="line">  "SpjMemoryLimit": 256, // 以上几行为评测信息显示限制</span><br><span class="line">  "SandboxEnvironments": [ // sandbox 内的环境变量</span><br><span class="line">    "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",</span><br><span class="line">    <span class="string">"HOME=/tmp"</span></span><br><span class="line">  ],</span><br><span class="line">  "SandboxUser": "nobody",</span><br><span class="line">  "SandboxRoot": "/sandbox-rootfs", // sandbox 所在目录</span><br><span class="line">  "BinaryDirectory": "/mnt/syzoj-bin" // runner 所要执行的可执行文件的目录</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>runner-instance1.json</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "WorkingDirectory": "/mnt/syzoj-tmp1", // 工作目录</span><br><span class="line">  "SandboxCgroup": "syzoj-1" // sandbox 相关</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建-systemd-系统服务"><a href="#创建-systemd-系统服务" class="headerlink" title="创建 systemd 系统服务"></a>创建 systemd 系统服务</h3><p>分别在 <code>/etc/systemd/system/</code> 目录下建立以下文件并写入以下内容。需要注意的是如果你是用 nvm 或其他方式安装了 Node.js，<code>node</code> 可执行文件的位置可能会有不同，请自行修改。</p>
<p><code>syzoj-web.service</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=SYZOJ <span class="literal">On</span>line Judge</span><br><span class="line"><span class="attr">After</span>=network.target mysql.service</span><br><span class="line"><span class="attr">Requires</span>=mysql.service</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=simple</span><br><span class="line"><span class="attr">WorkingDirectory</span>=/var/syzoj-web</span><br><span class="line"><span class="attr">User</span>=syzoj</span><br><span class="line"><span class="attr">Group</span>=syzoj</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/node /var/syzoj-web/app.js -c /etc/syzoj-config/web.json</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
<p><code>syzoj-judge-daemon.service</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=SYZOJ Daemon</span><br><span class="line"><span class="attr">After</span>=network.target mysql.service rabbitmq-server.service redis-server.service</span><br><span class="line"><span class="attr">Requires</span>=mysql.service rabbitmq-server.service redis-server.service</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=simple</span><br><span class="line"><span class="attr">WorkingDirectory</span>=/var/syzoj-judge-v3</span><br><span class="line"><span class="attr">User</span>=syzoj</span><br><span class="line"><span class="attr">Group</span>=syzoj</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/node /var/syzoj-judge-v3/lib/daemon/index.js -c /etc/syzoj-config/daemon.json</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
<p><code>syzoj-judge-frontend.service</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=SYZOJ Judge Frontend</span><br><span class="line"><span class="attr">After</span>=network.target rabbitmq-server.service</span><br><span class="line"><span class="attr">Requires</span>=syzoj-web.service rabbitmq-server.service</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=simple</span><br><span class="line"><span class="attr">WorkingDirectory</span>=/var/syzoj-judge-v3</span><br><span class="line"><span class="attr">User</span>=syzoj</span><br><span class="line"><span class="attr">Group</span>=syzoj</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/node /var/syzoj-judge-v3/lib/frontend-syzoj/index.js -c /etc/syzoj-config/frontend.json</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
<p><code>syzoj-judge-runner@.service</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=SYZOJ Runner %I</span><br><span class="line"><span class="attr">After</span>=network.target rabbitmq-server.service redis-server.service</span><br><span class="line"><span class="attr">Requires</span>=rabbitmq-server.service redis-server.service</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=simple</span><br><span class="line"><span class="attr">WorkingDirectory</span>=/var/syzoj-judge-v3</span><br><span class="line"><span class="attr">User</span>=root</span><br><span class="line"><span class="attr">Group</span>=root</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/node /var/syzoj-judge-v3/lib/runner/index.js -s /etc/syzoj-config/runner-shared.json -i /etc/syzoj-config/runner-instance%i.json</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.targe</span><br></pre></td></tr></table></figure>
<p>欲启用系统服务，请在终端中键入以下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable syzoj-web</span><br><span class="line">systemctl enable syzoj-judge-daemon</span><br><span class="line">systemctl enable syzoj-judge-frontend</span><br><span class="line">systemctl enable syzoj-runner@1</span><br></pre></td></tr></table></figure>
<h3 id="创建-syzoj-系统用户"><a href="#创建-syzoj-系统用户" class="headerlink" title="创建 syzoj 系统用户"></a>创建 syzoj 系统用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">useradd syzoj</span><br><span class="line">mkdir /home/syzoj</span><br><span class="line">chown -R syzoj:syzoj /mnt/syzoj-data</span><br><span class="line">chown -R syzoj:syzoj /mnt/syzoj-bin</span><br><span class="line">chown -R syzoj:syzoj /mnt/syzoj-tmp1</span><br><span class="line">chown -R syzoj:syzoj /var/syzoj-web</span><br><span class="line">chown -R syzoj:syzoj /var/syzoj-judge-v3</span><br><span class="line">chown -R syzoj:syzoj /home/syzoj</span><br></pre></td></tr></table></figure>
<h3 id="配置临时目录"><a href="#配置临时目录" class="headerlink" title="配置临时目录"></a>配置临时目录</h3><p>SYZOJ 使用 tmpfs 挂载临时目录。你需要在 <code>/etc/fstab</code> 文件中加入以下内容。</p>
<p><code>/etc/fstab</code></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The following items are for SYZOJ Judge:</span></span><br><span class="line">tmpfs /mnt/syzoj-tmp1 tmpfs nodev,nosuid,<span class="attribute">size</span>=384M 0 2</span><br><span class="line">tmpfs /mnt/syzoj-bin tmpfs nodev,nosuid,<span class="attribute">size</span>=1280M 0 2</span><br><span class="line">tmpfs /mnt/syzoj-tmp2 tmpfs nodev,nosuid,<span class="attribute">size</span>=384M 0 2</span><br></pre></td></tr></table></figure>
<p><code>/etc/fstab</code> 文件会在重启后生效。如果你不想立即重启，也可以自行挂载。具体方式请自行探索，这里不再赘述。</p>
<h3 id="配置-Nginx-反向代理"><a href="#配置-Nginx-反向代理" class="headerlink" title="配置 Nginx 反向代理"></a>配置 Nginx 反向代理</h3><p>SYZOJ web 端的默认端口是5283。想要从外部网络不加端口地访问，你需要配置 Nginx 以将5283端口反向代理到80端口。</p>
<p>在 <code>/etc/nginx/sites-available</code> 目录下建立名为 <code>syzoj</code> 和 <code>syzoj-judge</code> 的文件。中括号中内容请自行替换，作为参考，中括号处在官方示例文件中分别为 <code>syzoj-demo.t123yh.xyz</code>与 <code>syzoj-demo-judge.t123yh.xyz</code>。这里没有配置 ssl，感兴趣的读者可以自行配置。</p>
<p><code>syzoj</code></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">	<span class="attribute">server_name</span> [your_domain_or_ip];</span><br><span class="line"></span><br><span class="line">	<span class="attribute">location</span> / &#123;</span><br><span class="line">		<span class="attribute">proxy_set_header</span> Host <span class="variable">$http_host</span>;</span><br><span class="line">		<span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">		<span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">		<span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line"></span><br><span class="line">		<span class="attribute">proxy_pass</span> http://127.0.0.1:5283;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>syzoj-judge</code></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">	<span class="attribute">server_name</span> [your_judge_domain];</span><br><span class="line"></span><br><span class="line">	<span class="attribute">location</span> / &#123;</span><br><span class="line">		<span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">		<span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">		<span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">		<span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line"></span><br><span class="line">		<span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">		<span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">		<span class="attribute">proxy_set_header</span> Connection <span class="string">"upgrade"</span>;</span><br><span class="line"></span><br><span class="line">		<span class="attribute">proxy_pass</span> http://127.0.0.1:5284;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之后，在终端中输入以下命令以启用刚刚创建的配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ln -s /etc/nginx/sites-available/syzoj /etc/nginx/sites-enabled/syzoj</span><br><span class="line">ln -s /etc/nginx/sites-available/syzoj-judge /etc/nginx/sites-enabled/syzoj-judge</span><br><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>
<h3 id="在网站注册用户并设置为管理员"><a href="#在网站注册用户并设置为管理员" class="headerlink" title="在网站注册用户并设置为管理员"></a>在网站注册用户并设置为管理员</h3><p>此时 SYZOJ 已部署完毕，你可以尝试启动。</p>
<p>启动的方式有几种。如果为了方便在部署测试中查看输出日志，你可以使用 <code>screen</code> 命令打开四个会话并分别后台运行 web、daemon、frontend 和 runner。</p>
<p>四个进程的启动命令分别是</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">node /var/syzoj-web/app.js -c /etc/syzoj-config/web.json</span><br><span class="line">node /var/syzoj-judge-v3/lib/frontend-syzoj/index.js -c /etc/syzoj-config/frontend.json</span><br><span class="line">node /var/syzoj-judge-v3/lib/runner/index.js -s /etc/syzoj-config/runner-shared.json -i /etc/syzoj-config/runner-instance1.json</span><br></pre></td></tr></table></figure>
<p><code>screen</code> 命令的使用方式不再赘述。更好的方式是使用刚才建立好的系统服务。执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl start syzoj-web</span><br><span class="line">systemctl start syzoj-judge-daemon</span><br><span class="line">systemctl start syzoj-judge-frontend</span><br><span class="line">systemctl start syzoj-judge-runner@1</span><br></pre></td></tr></table></figure>
<p>执行后，如果启动成功，<code>ps-ef | grep node</code> 应该可以看到你的四个进程。如果没有看到，那么请自行查看日志或考虑使用 <code>screen</code> 进行调试。</p>
<p>如果启动成功，那么此时访问 <code>http://服务器ip或域名</code> 应该能打开 SYZOJ 的默认界面。你应该注册一个新用户并将其设置为管理员。</p>
<p>注册后，进入 MySQL Cli，键入以下命令，自行替换中括号内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">USE syzoj;</span><br><span class="line">UPDATE `user` SET `is_admin` = 1 WHERE `username` = &apos;[your_username]&apos;;</span><br></pre></td></tr></table></figure>
<p>刷新页面，应该能看到你的账户已经成了全站管理员。SYZOJ 的全站管理员权限只能通过更改数据库的方式添加或删除。</p>
<p>这时你可以加入题目并提交以测试评测端是否运行正常。如果成功评测并显示结果，那么恭喜你，你的 SYZOJ 部署成功。注意如果添加过题目又删除，那么自动增长的默认题目编号不会排除被删除的题目，所以请谨慎添加。如果确实添加错了题目，可以考虑将下一道新题目通过编辑错误题目的方式添加。</p>
<h3 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h3><p><strong>这都是我遇到过的坑</strong></p>
<p>如果浏览器显示你的服务器拒绝了请求，那么有可能是 web 端未能正常运行。考虑重启 web 端。</p>
<p>如果显示 502 Bad Gateway，请访问 <code>http://服务器地址:5283/</code> 。如果成功打开，那么可能是 Nginx 的反向代理设置错误。</p>
<p>如果在提交后评测状态始终为 Waiting，请先刷新页面。如果刷新多次后仍为 Waiting，那么可以猜测评测端出了问题。请逐个排查 daemon、frontend 与 runner。</p>
<p>如果运行 runner 后显示</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WARNING: You are likely using a <span class="keyword">version</span> of <span class="keyword">node</span><span class="title">-tar</span> <span class="keyword">or</span> npm that is incompatible with this <span class="keyword">version</span> of <span class="keyword">Node</span>.<span class="title">js</span>.</span><br></pre></td></tr></table></figure>
<p>有可能是 Node.js 的版本问题。请安装文首推荐的 Node.js 版本重试。</p>
<p>如果运行 frontend 后出现两行找不到文件的错误信息，请考虑 <code>cd</code> 到 <code>/var/syzoj-judge-v3</code>下后再执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node /var/syzoj-judge-v3/lib/frontend-syzoj/index.js -c /etc/syzoj-config/frontend.json</span><br></pre></td></tr></table></figure>
<h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>到这里，SYZOJ 的部署应该就结束了，您可以进一步自定义设置或自行定制 SYZOJ 系统本身。如果想进一步折腾，可以考虑在 docker 中部署 SYZOJ，方便重新部署、备份数据。（如果你成功了，希望你向开发者提交实现方式或者发布打包好的 image 来造福社会（</p>
<p>感谢 Menci 与 t123yh 开发了如此方便易用的OJ并开源。</p>
<p>Fin.</p>
</div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>Masellum</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2018/08/syzoj-setup/">http://blog.masellum.me/2018/08/syzoj-setup/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本作品采用<a href="http://creativecommons.org/licenses/by/4.0/" target="_blank">知识共享署名 4.0 国际许可协议</a>进行许可。</li></ul></div><br><div class="tags"><a href="/tags/SYZOJ/">SYZOJ</a><a href="/tags/Linux/">Linux</a></div><div class="post-nav"><a class="pre" href="/2018/08/Luogu-P1541/">[NOIP2010] 乌龟棋</a><a class="next" href="/2018/08/Luogu-P1196/">[NOI2002] 银河英雄传说</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'http://blog.masellum.me/2018/08/syzoj-setup/';
    this.page.identifier = '2018/08/syzoj-setup/';
    this.page.title = 'SYZOJ 部署指南';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//masellum-blog.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//masellum-blog.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://masellum-blog.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/其他/">其他</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/学习笔记/">学习笔记</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/题解/">题解</a><span class="category-list-count">5</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/生成树/" style="font-size: 15px;">生成树</a> <a href="/tags/并查集/" style="font-size: 15px;">并查集</a> <a href="/tags/递推/" style="font-size: 15px;">递推</a> <a href="/tags/搜索/" style="font-size: 15px;">搜索</a> <a href="/tags/动态规划/" style="font-size: 15px;">动态规划</a> <a href="/tags/LCA/" style="font-size: 15px;">LCA</a> <a href="/tags/带权并查集/" style="font-size: 15px;">带权并查集</a> <a href="/tags/数论/" style="font-size: 15px;">数论</a> <a href="/tags/数学/" style="font-size: 15px;">数学</a> <a href="/tags/学习笔记/" style="font-size: 15px;">学习笔记</a> <a href="/tags/SYZOJ/" style="font-size: 15px;">SYZOJ</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/09/Number-Theory-Note/">数论学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/Luogu-P1311/">[NOIP2011] 选择客栈</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/Luogu-P1514/">[NOIP2010] 引水入城</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/Luogu-P1541/">[NOIP2010] 乌龟棋</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/syzoj-setup/">SYZOJ 部署指南</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/Luogu-P1196/">[NOI2002] 银河英雄传说</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/Luogu-P1967/">[NOIP2013] 货车运输</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//masellum-blog.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://oi.men.ci/" title="Menci's Blog" target="_blank">Menci's Blog</a><ul></ul><a href="https://mzwuzad.github.io/" title="Mzwuzad's Blog" target="_blank">Mzwuzad's Blog</a><ul></ul><a href="https://oi.logey.cn/" title="Logey's Blog" target="_blank">Logey's Blog</a><ul></ul><a href="http://blog.aor.sd.cn/" title="Rain Air's Blog" target="_blank">Rain Air's Blog</a><ul></ul><a href="https://blog.ishq.site/" title="Shq's Blog" target="_blank">Shq's Blog</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">Mas's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div><script>if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js?t=1536312509854')
    .then(function () {console.log('ServiceWorker Register Successfully.')})
    .catch(function (e) {console.error(e)});
}
</script></body></html>